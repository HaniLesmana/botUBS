from cmath import log
import logging
import telebot
import mysql.connector
from telebot import types
from telegram import ReplyKeyboardMarkup, Update, ReplyKeyboardRemove, InlineKeyboardButton
from telegram.ext import (
    Updater,
    CommandHandler,
    MessageHandler,
    Filters,
    ConversationHandler,
    CallbackContext,
)
mydb = mysql.connector.connect(
    host = 'localhost',
    user = 'root',
    password = '',
    database= 'dbubs'
)
sql = mydb.cursor()
# Enable logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)
reply_keyboard = [
    ['Ya', 'Tidak'],
]
markup = ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True)
step1, step2, step3, step4, step5, step6, step7,stepAdmin1, stepAdminCreate,stepAdminRead = range(10)

def start(update: Update, context: CallbackContext) -> int:
    """Start the conversation and ask user for input."""
    update.message.reply_text(
        "Hi! My name is Doctor Botter. Please insert your NIK and password (Format: NIK-Password )",
    )
    ctrPertanyaan = 0    
    return step1

def cekData(update: Update, context: CallbackContext) -> int:
    """Ask the user for info about the selected predefined choice."""        
    text = ""
    nik = ""
    password = ""
    format_salah = False
    try:
        text = update.message.text.split("-") 
        nik = text[0]
        password = text[1]
    except:
        format_salah = True
        update.message.reply_text('Format salah (Contoh : "30123534345-password")')
    sql.execute("select * from karyawan where nik = '{}' and password = '{}' ".format(nik,password))
    hasil_sql = sql.fetchall()
    if (nik=="admin") and (password=="admin") and format_salah == False:
        logging.basicConfig("TES")
        context.user_data['nik'] = "admin"
        context.user_data['password'] = "admin"
        context.user_data['nama'] = "Admin"
        update.message.reply_text(f'Halo, Admin! Please click "/continue" to start')
        return stepAdmin1    
    if len(hasil_sql)<=0 and format_salah == False:
        update.message.reply_text('User tidak ada')    
    else:
        context.user_data['nik'] = nik
        context.user_data['password'] = password
        context.user_data['nama'] = hasil_sql[0][1]
        update.message.reply_text(f'Halo, {hasil_sql[0][1]}. Please click "/continue" to start')
        return step1    

def admin1(update: Update, context: CallbackContext) -> int:
    keyboard = [
        ["1. Create","2. Read","3. Update","4. Delete"],
    ]    
    markupadmin1 = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True)
    if len(context.user_data)>0:
        update.message.reply_text(
            'Admin Ingin apa? \n 1. Create Pertanyaan \n 2. Read Pertanyaan \n 3. Update Pertanyaan \n 4. Delete Pertanyaan',reply_markup=markupadmin1 
        )
        return stepAdminCreate
    else :
        update.message.reply_text(
            'Please click "/start"' 
        )

def adminCreate(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:
        update.message.reply_text(
            'Inputkan pertanyaan! (Format : pertanyaan-nilai)' 
        )
        text = update.message.text.split("-") 
        pertanyaan = text[0]
        nilai = text[1]   
        
        sql.execute("select count(*) from data_pertanyaan")
        hasilquery = sql.fetchone()
        hasil = str((hasilquery[0]+1))
        id = "P_"+(hasil).zfill(3)
        query = "INSERT INTO data_pertanyaan (ID_pertanyaan, pertanyaan, nilai) VALUES (%s, %s, %s)"
        val = (id, pertanyaan, nilai)
        sql.execute(query, val) 
        mydb.commit()
    else :
        update.message.reply_text(
            'Please click "/start"' 
        )
def adminRead(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:        
        sql.execute("SELECT * from data_pertanyaan")
        hasil = sql.fetchall()
        update.message.reply_text(
            hasil 
        )
    else :
        update.message.reply_text(
            'Please click "/start"' 
        )

def quest1(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:
        sql.execute("SELECT * from data_pertanyaan")
        hasil = sql.fetchall()
        temp = len(hasil)        
        update.message.reply_text(
            len(hasil),reply_markup=markup 
        )
        return step2
    else :
        update.message.reply_text(
            'Please click "/start"' 
        )

def quest2(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:
        update.message.reply_text(
            'apakah anda mengalami batuk/pilek atau keduanya?',reply_markup=markup 
        )
        return step3
    else :
        update.message.reply_text(
            'Please click "/start"'
        )

def quest3(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:
        update.message.reply_text(
            'Apakah anda mengalami penurunan kemampuan penciuman dan pengecap ?',reply_markup=markup 
        )
        return step4
    else :
        update.message.reply_text(
            'Please click "/start"'
        )

def quest4(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:
        update.message.reply_text(
            'Apakah anda mengalami nyeri tenggorokan ?',reply_markup=markup 
        )
        return step5
    else :
        update.message.reply_text(
            'Please click "/start"' 
        )

def quest5(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:
        update.message.reply_text(
            'Apakah anda mengalami lemah, letih dan lesu ?',reply_markup=markup 
        )
        return step6
    else :
        update.message.reply_text(
            'Please click "/start"' 
        )

def quest6(update: Update, context: CallbackContext) -> int:
    if len(context.user_data)>0:
        update.message.reply_text(
            'Apakah anda mengalami sesak nafas ?',reply_markup=markup 
        )
        return step7
    else :
        update.message.reply_text(
            'Please click "/start"'
        )
def main() -> None:
    """Run the bot."""
    # Create the Updater and pass it your bot's token.
    updater = Updater("5178114629:AAEAYhJz1XRZSjiXfmJIP_AFFNdC6c1nwUQ")
    # regex (nik-password) (\d{16})[-](\w)
    # Get the dispatcher to register handlers
    dispatcher = updater.dispatcher
    ctrPertanyaan = 0
    # Add conversation handler with the states CHOOSING, TYPING_CHOICE and TYPING_REPLY
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            stepAdmin1: [
                MessageHandler(
                    Filters.text & ~(Filters.command), cekData
                ),
                MessageHandler(Filters.regex('^/continue$'), admin1),                
            ],
            stepAdminCreate: [
                MessageHandler(
                    Filters.text & ~(Filters.command), adminCreate
                ),             
            ],
            stepAdminRead: [
                MessageHandler(
                    Filters.text & ~(Filters.command), adminRead
                ),             
            ],
            step1: [
                MessageHandler(
                    Filters.text & ~(Filters.command), cekData
                ),
                MessageHandler(Filters.regex('^/continue$'), quest1),                
            ],
            step2 : [
                MessageHandler(
                    Filters.text & ~(Filters.command), quest2
                ),
            ],
            step3 : [
                MessageHandler(
                    Filters.text & ~(Filters.command), quest3
                ),
            ],
            step4 : [
                MessageHandler(
                    Filters.text & ~(Filters.command), quest4
                ),
            ],
            step5 : [
                MessageHandler(
                    Filters.text & ~(Filters.command), quest5
                ),
            ],
            step6 : [
                MessageHandler(
                    Filters.text & ~(Filters.command), quest6
                ),
            ],
            step7 : [
                MessageHandler(
                    Filters.text & ~(Filters.command), quest5
                ),
            ]
        },
        fallbacks=[MessageHandler(Filters.regex('^Done$'),cekData)],
    )

    dispatcher.add_handler(conv_handler)

    # Start the Bot
    updater.start_polling()

    # Run the bot until you press Ctrl-C or the process receives SIGINT,
    # SIGTERM or SIGABRT. This should be used most of the time, since
    # start_polling() is non-blocking and will stop the bot gracefully.
    updater.idle()


if __name__ == '__main__':
    main()