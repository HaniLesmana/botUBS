import logging
import telebot
import mysql.connector
from telebot import types
from telegram import ReplyKeyboardMarkup, Update, ReplyKeyboardRemove
from telegram.ext import (
    Updater,
    CommandHandler,
    MessageHandler,
    Filters,
    ConversationHandler,
    CallbackContext,
)
mydb = mysql.connector.connect(
    host = 'localhost',
    user = 'root',
    password = '',
    database= 'dbubs'
)
sql = mydb.cursor()
# Enable logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)
reply_keyboard = [
    ['Ya', 'Tidak'],
]
markup = ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=True)
step1, step2, step3, step4 = range(4)

def start(update: Update, context: CallbackContext) -> int:
    """Start the conversation and ask user for input."""
    update.message.reply_text(
        "Hi! My name is Doctor Botter. Please insert your NIK and password (Format: NIK-Password )",
    )
    return step1

def cekData(update: Update, context: CallbackContext) -> int:
    """Ask the user for info about the selected predefined choice."""        
    text = update.message.text.split("-") 
    nik = text[0]
    password = text[1]
    sql.execute("select * from karyawan where nik = '{}' and password = '{}' ".format(nik,password))
    hasil_sql = sql.fetchall()
    if len(hasil_sql)<=0:
        update.message.reply_text('User tidak ada')    
    else:
        update.message.reply_text(f'Halo, {hasil_sql[0][1]}. Please click "/continue" to start')
        return step1    

def quest1(update: Update, context: CallbackContext) -> int:
    update.message.reply_text(
        'apakah anda mengalami demam?',reply_markup=markup 
    )

def main() -> None:
    """Run the bot."""
    # Create the Updater and pass it your bot's token.
    updater = Updater("5178114629:AAEAYhJz1XRZSjiXfmJIP_AFFNdC6c1nwUQ")
    # regex (nik-password) (\d{16})[-](\w)
    # Get the dispatcher to register handlers
    dispatcher = updater.dispatcher

    # Add conversation handler with the states CHOOSING, TYPING_CHOICE and TYPING_REPLY
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start)],
        states={
            step1: [
                MessageHandler(
                    Filters.text & ~(Filters.command), cekData
                ),
                MessageHandler(Filters.regex('^/s$'), quest1),                
            ]
        },
        fallbacks=[MessageHandler(Filters.regex('^Done$'),cekData)],
    )

    dispatcher.add_handler(conv_handler)

    # Start the Bot
    updater.start_polling()

    # Run the bot until you press Ctrl-C or the process receives SIGINT,
    # SIGTERM or SIGABRT. This should be used most of the time, since
    # start_polling() is non-blocking and will stop the bot gracefully.
    updater.idle()


if __name__ == '__main__':
    main()